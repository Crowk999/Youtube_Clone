{% extends 'base.html' %}
{% load static %}

{% block title %} Upload Video {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/videos.css' %}">
<link rel="stylesheet" href="{% static 'css/upload.css' %}">
{% endblock %}

{% block content %}
<div class="upload-overlay" id="uploadOverlay">
    <div class="upload-progress-container">
        <div class="upload-spinner">
            <h2>Uploading Video....</h2>
            <p class="upload-warning"> Please don't close this page </p>
        </div>
    </div>
</div>

<div class="upload-container">
    <div class="upload-card">

        <form id="uploadForm" method="post" enctype="multipart/form-data" class="upload-form">
            {% csrf_token %}
            <div id="errorContainer">
                {% if form.errors %}
                <ul class="error-list">
                    {% for field in form %}
                    {% for error in field.errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                    {% endfor %}

                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_tittle"> Tittle </label>
                <input type="text" name="tittle" id="id_tittle" class="form-input" placeholder="Enter video tittle"
                    value="{{ form.tittle.value|default:'' }}" required>
            </div>

            <div class="form-group">
                <label for="id_description"> Description </label>
                <textarea name="description" id="id_description" class="form-input"
                    placeholder="Enter video description" rows="3" required>{{form.description.value | default:''}}
                </textarea>
            </div>

            <div class="form-group">
                <label for="id_video_file"> Video File </label>
                <label for="id_video_file" class="file-input-wrapper">
                    <span id="video-label"> Click to select a video file </span>
                </label>
                <input type="file" name="video_file" id="id_video_file" accept="video/*" required
                    style="display: none;">
                <span class="help-text"> MP4, WebM, MOV, AVI, Max:100MB </span>
            </div>

            <div class="form-group">
                <label for="customThumbnail"> Thumbnail (Optional) </label>
                <label for="customThumbnail" class="file-input-wrapper thumb-wrapper">
                    <img id="thumbPreview">
                    <span id="thumb-label">Click to select a thumbnail</span>
                </label>
                <input type="file" id="customThumbnail" accept="image/*" style="display: none;">
                <input type="hidden" name="thumbnail_data" id="ThumbnailData">
                <span class="help-text"> Leave empty to auto generate form video </span>
            </div>

            <button type="submit" class="btn-submit" id="submitBtn"> Upload Video</button>

        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const $ = id => document.getElementById(id);
    $("id_video_file").onchange = e => {
        const file = e.target.files[0]
        $("video-label").textContent = file ? `${file.name}` : "Click to select a video file"
    }

    $("customThumbnail").onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const render = new FileReader()
        render.onload = ev => {
            $("thumbPreview").src = ev.target.result
            $("thumbPreview").classList.add("visible")
            $("thumb-label").style.display = "none"
            $("ThumbnailData").value = ev.target.result;
        }
        render.readAsDataURL(file)
    }

    $("uploadForm").onsubmit = async e => {
        e.preventDefault()

        if (!$("id_video_file").files.length || !$("id_tittle").value.trim()) {
            alert("Please provide all required fields.")
            return
        }

        $("uploadOverlay").classList.add("active");
        $("submitBtn").disabled = true;
        $("errorContainer").innerHTML = "";
        window.onbeforeunload = () => "Uploading in progress, please don't close the page.";

        try {
            const res = await fetch("{% url 'videos:upload_submit' %}", {
                method: "POST",
                body: new FormData($("uploadForm"))
            });
            const data = await res.json()
            window.onbeforeunload = null;

            if (data.success) {
                $("uploadOverlay").textContent = "Upload Complete"
                setTimeout(() => location.href = '/', 500)
            } else {
                throw new Error(data.error)
            }
        } catch (err) {
            window.onbeforeunload = null;
            $("uploadOverlay").classList.remove("active")
            $("submitBtn").disabled = false;
            $("errorContainer").innerHTML = `<ul class="error-list"><li>${err.message || "An error occurred during upload."}</li></ul>`
        }
    }


</script>
{% endblock %}